<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Patito Parlante ğŸ¦†</title>
</head>
<body>
  <h1>ğŸ™ï¸ Patito Parlante con DetecciÃ³n de Silencio</h1>
  <button id="iniciar">Iniciar conversaciÃ³n</button>
  <p id="estado">Esperando...</p>
  <audio id="player" controls></audio>

  <script>
    const estado = document.getElementById("estado");
    const player = document.getElementById("player");
    const botonIniciar = document.getElementById("iniciar");

    let stream = null;
    let audioContext = null;
    let source = null;
    let analyser = null;
    let dataArray = null;
    let mediaRecorder = null;

    const umbralSilencio = 10;  // volumen mÃ­nimo para considerar sonido
    const maxSilencio = 3000;   // ms para detectar silencio (3 segundos)
    let ultimoSonido = Date.now();
    let grabando = false;

    // FunciÃ³n para iniciar la grabaciÃ³n con detecciÃ³n de silencio
    async function empezarGrabacion() {
      estado.textContent = "âºï¸ Grabando... habla ahora";

      if (!stream) {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      }

      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      if (source) source.disconnect();
      source = audioContext.createMediaStreamSource(stream);

      analyser = audioContext.createAnalyser();
      analyser.fftSize = 512;
      source.connect(analyser);

      dataArray = new Uint8Array(analyser.frequencyBinCount);

      const chunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);

      mediaRecorder.onstop = async () => {
        grabando = false;
        estado.textContent = "ğŸ“¤ Enviando audio al backend...";
        const blob = new Blob(chunks, { type: "audio/webm" });

        // Enviar audio grabado a /conversar
        try {
          const formData = new FormData();
          formData.append("audio", blob, "grabacion.webm");

          const response = await fetch("http://localhost:8000/conversar", {
            method: "POST",
            body: formData
          });

          if (!response.ok) throw new Error("Error en el servidor");

          const patoBlob = await response.blob();
          const patoUrl = URL.createObjectURL(patoBlob);

          player.src = patoUrl;
          player.play();

          estado.textContent = "ğŸ¦† El patito respondiÃ³. Escuchando...";

          player.onended = () => {
            // Cuando termine de reproducir, vuelve a grabar
            empezarGrabacion();
          };

        } catch (err) {
          console.error("âŒ Error al enviar o recibir audio:", err);
          estado.textContent = "âŒ Error al comunicar con el servidor.";
        }
      };

      grabando = true;
      mediaRecorder.start();
      ultimoSonido = Date.now();

      // FunciÃ³n para detectar silencio y detener grabaciÃ³n
      function detectarSilencio() {
        analyser.getByteFrequencyData(dataArray);
        const volumen = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;

        if (volumen < umbralSilencio) {
          if (Date.now() - ultimoSonido > maxSilencio && grabando) {
            estado.textContent = "ğŸ›‘ Silencio detectado, deteniendo grabaciÃ³n...";
            mediaRecorder.stop();
            // No detener stream para reusar
            return;
          }
        } else {
          ultimoSonido = Date.now();
        }

        if (grabando) {
          requestAnimationFrame(detectarSilencio);
        }
      }
      detectarSilencio();
    }

    // FunciÃ³n para iniciar la conversaciÃ³n (primer fetch a /iniciar)
async function iniciarConversacion() {
  console.log("ğŸ“¡ Enviando solicitud a /iniciar");

  try {
    // Paso 1: obtener texto de la conversaciÃ³n
    const response = await fetch("http://127.0.0.1:8000/iniciar", {
      method: "GET"
    });

    if (!response.ok) {
      throw new Error("Error en /audio: " + response.status);
    }
    console.log(response)

    // ğŸ‘‡ Consumir el blob del audio
   const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);

    // ğŸ‘‡ Reproducir
    const player = document.getElementById("player");
    player.src = audioUrl;
    console.log('llegamo aca')
    console.log(player) 
    await player.play(); 

      player.onended = () => {
      console.log("ğŸ§ ReproducciÃ³n terminada");
      empezarGrabacion()
    };



  } catch (err) {
    console.error("âŒ Error al iniciar conversaciÃ³n:", err);
    estado.textContent = "âŒ Error al iniciar conversaciÃ³n.";
  }
}



    // Al apretar el botÃ³n, deshabilitar botÃ³n y empezar conversaciÃ³n
    botonIniciar.onclick = () => {
      botonIniciar.disabled = true;
      iniciarConversacion();
    };
  </script>
</body>
</html>
